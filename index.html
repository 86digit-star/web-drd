<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F&B Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Expose functions to window so Babel script can use them
        window.firebaseModules = { 
            initializeApp, getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch 
        };
    </script>

    <style>
        /* Cleaner UI Tweaks */
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .soft-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white; height: auto !important; overflow: visible !important; }
            #root, main, .flex, .h-screen { height: auto !important; overflow: visible !important; display: block !important; }
            .sidebar { display: none !important; }
            .card-print { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; overflow: visible !important; }
            .overflow-x-auto, .overflow-y-auto { overflow: visible !important; }
        }

        /* Toast Animation */
        @keyframes slideInBottom {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- FIREBASE SETUP ---
        const { initializeApp, getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, writeBatch } = window.firebaseModules;

        const firebaseConfig = {
            apiKey: "AIzaSyD1FF48OmU_-AJj4iqb8sJlqfW-X28rWDc",
            authDomain: "web-drd.firebaseapp.com",
            projectId: "web-drd",
            storageBucket: "web-drd.firebasestorage.app",
            messagingSenderId: "124923823270",
            appId: "1:124923823270:web:c91f0062a1ab152628e067"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- CUSTOM HOOK: FIRESTORE SYNC ---
        const useFirestore = (collectionName) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onSnapshot(collection(db, collectionName), (snapshot) => {
                    const items = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                    setData(items);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error getting ${collectionName}:`, error);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, [collectionName]);

            const add = async (item) => {
                try {
                    const { id, ...itemWithoutId } = item; // Let Firestore generate ID
                    await addDoc(collection(db, collectionName), itemWithoutId);
                } catch (e) { console.error("Error adding:", e); }
            };

            const update = async (item) => {
                try {
                    if (!item.id) return;
                    const docRef = doc(db, collectionName, item.id);
                    const { id, ...itemWithoutId } = item;
                    await updateDoc(docRef, itemWithoutId);
                } catch (e) { console.error("Error updating:", e); }
            };

            const remove = async (id) => {
                try {
                    await deleteDoc(doc(db, collectionName, id));
                } catch (e) { console.error("Error deleting:", e); }
            };

            return { data, loading, add, update, remove };
        };

        // --- Mock Data & Constants (For Initial Seeding Only) ---
        const initialData = [
            { name: "Beras Pandan Wangi", category: "Bahan Kering", stock: 25, unit: "kg", price: 14000, minStock: 10 },
            { name: "Daging Sapi Slice", category: "Fresh Food", stock: 5, unit: "kg", price: 120000, minStock: 8 },
            { name: "Minyak Goreng", category: "Bahan Kering", stock: 12, unit: "liter", price: 18000, minStock: 10 },
            { name: "Paper Cup 12oz", category: "Packaging", stock: 800, unit: "pcs", price: 500, minStock: 200 },
            { name: "Kopi Arabica Blend", category: "Bahan Kering", stock: 3, unit: "kg", price: 250000, minStock: 5 },
            { name: "Susu UHT Full Cream", category: "Dairy", stock: 24, unit: "liter", price: 19000, minStock: 12 },
        ];

        const CATEGORIES = ["Fresh Food", "Bahan Kering", "Frozen Food", "Dairy", "Sayuran", "Packaging", "Cleaning"];
        const UNITS = ["kg", "gram", "liter", "ml", "pcs", "pack", "karton", "ikat", "butir"];

        // --- Components ---

        // Reliable Icon Component
        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = React.useRef(null);
            
            React.useEffect(() => {
                if (ref.current && window.lucide) {
                    window.lucide.createIcons({
                        root: ref.current,
                        nameAttr: 'data-lucide',
                        attrs: {
                            width: size,
                            height: size,
                            class: `lucide lucide-${name}`
                        }
                    });
                }
            }, [name, size]);

            return (
                <span ref={ref} className={`inline-flex items-center justify-center ${className}`}>
                    <i data-lucide={name}></i>
                </span>
            );
        };

        const Card = ({ children, className = "" }) => (
            <div className={`bg-white rounded-2xl shadow-[0_2px_12px_-2px_rgba(0,0,0,0.06)] border border-slate-100 p-6 ${className}`}>
                {children}
            </div>
        );

        // Toast Component
        const ToastContext = React.createContext();

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);

            const showToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts([...toasts, { id, message, type }]);
                setTimeout(() => {
                    setToasts(prev => prev.filter(t => t.id !== id));
                }, 3000);
            };

            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    <div className="fixed bottom-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`
                                pointer-events-auto flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg border animate-[slideInBottom_0.3s_ease-out]
                                ${toast.type === 'success' ? 'bg-white border-emerald-100 text-emerald-800' : ''}
                                ${toast.type === 'error' ? 'bg-white border-rose-100 text-rose-800' : ''}
                                ${toast.type === 'info' ? 'bg-slate-800 text-white border-transparent' : ''}
                            `} style={{ minWidth: '300px' }}>
                                <div className={`p-1 rounded-full ${toast.type === 'success' ? 'bg-emerald-100' : toast.type === 'error' ? 'bg-rose-100' : 'bg-slate-700'}`}>
                                    <Icon name={toast.type === 'success' ? 'check' : toast.type === 'error' ? 'alert-circle' : 'info'} size={16} />
                                </div>
                                <span className="text-sm font-medium">{toast.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => React.useContext(ToastContext);

        // Login Component
        const LoginScreen = ({ onLogin }) => {
            const [selectedRole, setSelectedRole] = useState(null);
            const [pin, setPin] = useState("");
            const [error, setError] = useState("");
            const [showPin, setShowPin] = useState(false);
            
            const [selectedFeatures, setSelectedFeatures] = useState({
                list: true, products: true, hpp: true, usage: true, restock: true, finance: true
            });

            const handleFeatureToggle = (key) => {
                setSelectedFeatures(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const handlePinSubmit = (e) => {
                e.preventDefault();
                const activeFeatures = Object.keys(selectedFeatures).filter(k => selectedFeatures[k]);
                
                if (selectedRole === 'owner' && pin === '1234') {
                    onLogin('owner', activeFeatures);
                } else if (selectedRole === 'ceo' && pin === '0000') {
                    onLogin('ceo', activeFeatures);
                } else {
                    setError("PIN Salah! Silakan coba lagi.");
                    setPin("");
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800 p-4">
                    <div className="max-w-md w-full bg-white rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
                        <div className="p-8 text-center border-b border-gray-100">
                            <div className="inline-flex p-3 bg-emerald-100 text-emerald-600 rounded-xl mb-4">
                                <Icon name="chef-hat" size={32} />
                            </div>
                            <h1 className="text-2xl font-bold text-gray-800">KitchenPro Login</h1>
                            <p className="text-gray-500 mt-2">Sistem Manajemen Inventaris Profesional</p>
                        </div>
                        
                        {!selectedRole ? (
                            <div className="p-8 space-y-4">
                                <p className="text-center text-sm text-gray-500 mb-4">Pilih otoritas akses:</p>
                                <button onClick={() => setSelectedRole('owner')} className="w-full p-4 flex items-center gap-4 border-2 border-gray-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-xl transition-all group text-left">
                                    <div className="p-3 bg-blue-100 text-blue-600 rounded-full group-hover:scale-110 transition-transform">
                                        <Icon name="shield-check" />
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">Owner / Administrator</div>
                                        <div className="text-xs text-gray-500">Akses Penuh (PIN: 1234)</div>
                                    </div>
                                </button>
                                <button onClick={() => setSelectedRole('ceo')} className="w-full p-4 flex items-center gap-4 border-2 border-gray-100 hover:border-emerald-500 hover:bg-emerald-50 rounded-xl transition-all group text-left">
                                    <div className="p-3 bg-purple-100 text-purple-600 rounded-full group-hover:scale-110 transition-transform">
                                        <Icon name="user-check" />
                                    </div>
                                    <div>
                                        <div className="font-bold text-gray-800">Staff / Operator</div>
                                        <div className="text-xs text-gray-500">Akses Terbatas (PIN: 0000)</div>
                                    </div>
                                </button>
                            </div>
                        ) : (
                            <div className="p-8">
                                <button onClick={() => { setSelectedRole(null); setError(""); setPin(""); }} className="text-sm text-gray-500 flex items-center gap-1 mb-6 hover:text-emerald-600">
                                    <Icon name="arrow-left" size={16} /> Kembali
                                </button>
                                
                                <h2 className="text-xl font-bold text-center mb-6">
                                    Masukan PIN {selectedRole === 'owner' ? 'Owner' : 'Staff'}
                                </h2>

                                <form onSubmit={handlePinSubmit} className="space-y-4">
                                    <div className="relative">
                                        <input 
                                            type={showPin ? "text" : "password"} autoFocus maxLength={4}
                                            className="w-full text-center text-3xl tracking-[1em] font-bold p-4 border-2 border-gray-200 rounded-xl focus:border-emerald-500 outline-none transition-colors"
                                            value={pin} onChange={e => { setPin(e.target.value.replace(/[^0-9]/g, '')); setError(""); }} placeholder="••••"
                                        />
                                        <button type="button" onClick={() => setShowPin(!showPin)} className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600 p-2">
                                            <Icon name={showPin ? "eye-off" : "eye"} size={20} />
                                        </button>
                                    </div>
                                    
                                    {error && <div className="text-rose-500 text-sm text-center font-medium animate-pulse">{error}</div>}

                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 mt-4">
                                        <div className="text-xs font-bold text-slate-500 uppercase mb-3 flex items-center gap-2">
                                            <Icon name="sliders" size={12} /> Pilih Fitur Aktif
                                        </div>
                                        <div className="space-y-2">
                                            {[
                                                { id: 'list', label: 'Stok Bahan', icon: 'package' },
                                                { id: 'products', label: 'Menu Resep', icon: 'coffee' },
                                                { id: 'hpp', label: 'Kalkulator HPP', icon: 'calculator' },
                                                { id: 'usage', label: 'Pemakaian Bahan', icon: 'clipboard-minus' },
                                                { id: 'restock', label: 'Pengadaan Stok', icon: 'shopping-cart' },
                                                { id: 'finance', label: 'Keuangan', icon: 'banknote', restricted: selectedRole !== 'owner' }
                                            ].map(feat => (
                                                !feat.restricted && (
                                                    <label key={feat.id} className="flex items-center gap-3 cursor-pointer group">
                                                        <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${selectedFeatures[feat.id] ? 'bg-emerald-500 border-emerald-500' : 'bg-white border-slate-300'}`}>
                                                            {selectedFeatures[feat.id] && <Icon name="check" size={12} className="text-white" />}
                                                        </div>
                                                        <input type="checkbox" className="hidden" checked={selectedFeatures[feat.id]} onChange={() => handleFeatureToggle(feat.id)} />
                                                        <span className={`text-sm ${selectedFeatures[feat.id] ? 'text-slate-700 font-medium' : 'text-slate-400'}`}>
                                                            {feat.label}
                                                        </span>
                                                    </label>
                                                )
                                            ))}
                                        </div>
                                    </div>

                                    <Button type="submit" className="w-full justify-center py-3 text-lg mt-4">
                                        Masuk Sistem
                                    </Button>
                                </form>
                            </div>
                        )}

                        <div className="bg-gray-50 p-4 text-center text-xs text-gray-400">
                            &copy; 2025 KitchenPro Inventory System v2.0 (Firebase Connected)
                        </div>
                    </div>
                </div>
            );
        };

        // Chart Component Wrapper
        const ChartComponent = ({ type, data, options, height = 250 }) => {
            const chartRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: { responsive: true, maintainAspectRatio: false, ...options }
                    });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, options, type]);

            return (
                <div style={{ height: height, width: '100%' }}>
                    <canvas ref={canvasRef}></canvas>
                </div>
            );
        };

        const Button = ({ onClick, children, variant = "primary", className = "", type = "button", disabled = false, size = "md" }) => {
            const baseStyle = "rounded-lg font-medium transition-all duration-200 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed";
            const sizes = { sm: "px-3 py-1.5 text-xs", md: "px-4 py-2" };
            const variants = {
                primary: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-sm hover:shadow-md",
                secondary: "bg-white text-gray-700 border border-gray-200 hover:bg-gray-50 hover:border-gray-300",
                danger: "bg-rose-50 text-rose-600 hover:bg-rose-100 border border-transparent",
                outline: "border border-gray-300 text-gray-600 hover:bg-gray-50",
                ghost: "text-gray-500 hover:bg-gray-100 hover:text-gray-700"
            };
            return (
                <button type={type} onClick={onClick} disabled={disabled} className={`${baseStyle} ${sizes[size]} ${variants[variant]} ${className}`}>
                    {children}
                </button>
            );
        };

        const Badge = ({ children, type = "default" }) => {
            const styles = {
                default: "bg-gray-100 text-gray-700 border border-gray-200",
                success: "bg-emerald-50 text-emerald-700 border border-emerald-100",
                warning: "bg-amber-50 text-amber-700 border border-amber-100",
                danger: "bg-rose-50 text-rose-700 border border-rose-100",
                info: "bg-blue-50 text-blue-700 border border-blue-100"
            };
            return (
                <span className={`px-2.5 py-0.5 rounded-full text-xs font-medium ${styles[type]}`}>
                    {children}
                </span>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center p-6 border-b sticky top-0 bg-white z-10">
                            <h3 className="text-lg font-bold text-gray-900">{title}</h3>
                            <button onClick={onClose} className="p-1 hover:bg-gray-100 rounded-full transition-colors">
                                <i data-lucide="x" className="w-5 h-5 text-gray-500"></i>
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Helpers ---
        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(number);
        const formatDate = (dateString) => new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });

        const InventoryList = ({ inventory, products, searchTerm, setSearchTerm, user, canEdit, setEditingItem, setShowFormModal, handleDelete, updateInventory, addLog, showToast, formatRupiah, setView }) => {
            const [filterMenuId, setFilterMenuId] = useState("all");
            const [opnameItem, setOpnameItem] = useState(null); 
            const [opnameActual, setOpnameActual] = useState("");

            const handleOpnameSubmit = (e) => {
                e.preventDefault();
                if (!opnameItem) return;
                
                const actualStock = parseFloat(opnameActual);
                if (isNaN(actualStock) || actualStock < 0) return showToast("Stok fisik tidak valid", 'error');

                const systemStock = opnameItem.stock;
                const variance = actualStock - systemStock;

                if (variance === 0) {
                    showToast("Stok sudah sesuai (Tidak ada selisih)", 'info');
                    setOpnameItem(null);
                    return;
                }

                // 1. Update Inventory in Firestore
                updateInventory({ ...opnameItem, stock: actualStock });

                // 2. Log Variance to Firestore
                addLog({
                    date: new Date().toISOString(),
                    itemId: opnameItem.id,
                    itemName: opnameItem.name,
                    amount: Math.abs(variance),
                    unit: opnameItem.unit,
                    reason: variance < 0 ? "Stok Opname (Loss/Hilang)" : "Stok Opname (Surplus/Lebih)",
                    cost: Math.abs(variance) * opnameItem.price
                });

                showToast(`Stok Opname berhasil! Selisih: ${variance} ${opnameItem.unit}`, variance < 0 ? 'warning' : 'success');
                setOpnameItem(null);
                setOpnameActual("");
            };

            const filtered = useMemo(() => {
                const term = searchTerm.toLowerCase();
                const matchingProductIds = new Set();
                let filteredInventory = inventory;

                if (filterMenuId !== "all") {
                    const targetProduct = products.find(p => p.id === filterMenuId);
                    if (targetProduct) {
                        const ingredientIds = new Set(targetProduct.recipe.map(r => r.itemId));
                        filteredInventory = filteredInventory.filter(i => ingredientIds.has(i.id));
                    }
                }

                if (term) {
                    products.forEach(p => {
                        if (p.name.toLowerCase().includes(term)) {
                            p.recipe.forEach(r => matchingProductIds.add(r.itemId));
                        }
                    });
                    filteredInventory = filteredInventory.filter(i => 
                        i.name.toLowerCase().includes(term) || i.category.toLowerCase().includes(term) || matchingProductIds.has(i.id)
                    );
                }
                return filteredInventory;
            }, [inventory, products, searchTerm, filterMenuId]);
            
            const [showColMenu, setShowColMenu] = useState(false);
            const [cols, setCols] = useState({ category: true, price: true, stock: true, status: true, action: true });
            const toggleCol = (key) => setCols({ ...cols, [key]: !cols[key] });

            return (
                <div className="space-y-6">
                    <div className="hidden print-only mb-6 border-b pb-4">
                        <div className="flex justify-between items-end">
                            <div><h1 className="text-2xl font-bold text-gray-900">Laporan Stok Opname</h1><p className="text-gray-500 mt-1">KitchenPro Inventory System</p></div>
                            <div className="text-right text-sm text-gray-600"><p>Tanggal: {new Date().toLocaleDateString('id-ID')}</p><p>User: {user?.name}</p></div>
                        </div>
                    </div>

                    <div className="flex flex-col md:flex-row gap-4 items-center no-print">
                        <div className="relative flex-1 w-full md:w-auto">
                            <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" />
                            <input type="text" placeholder="Cari bahan, kategori, menu..." className="w-full pl-10 pr-4 py-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white shadow-sm" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                        </div>
                        <select className="w-full md:w-auto p-2.5 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white shadow-sm text-sm" value={filterMenuId} onChange={e => setFilterMenuId(e.target.value)}>
                            <option value="all">Semua Menu</option>
                            {products.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                        </select>
                        {canEdit && (
                            <Button onClick={() => { setEditingItem({}); setShowFormModal(true); }} className="w-full md:w-auto justify-center">
                                <Icon name="plus" className="w-4 h-4" /> <span className="hidden sm:inline">Tambah Bahan</span>
                            </Button>
                        )}
                        <Button className="w-full md:w-auto justify-center bg-orange-500 hover:bg-orange-600 text-white shadow-orange-200" onClick={() => setView('usage')}>
                            <Icon name="clipboard-minus" className="w-4 h-4" /> <span className="hidden sm:inline">Catat Pemakaian</span>
                        </Button>
                        <Button variant="secondary" onClick={() => window.print()} className="w-full md:w-auto justify-center px-3" title="Print Laporan">
                            <Icon name="printer" className="w-4 h-4" />
                        </Button>
                        <div className="relative w-full md:w-auto">
                            <Button variant="secondary" onClick={() => setShowColMenu(!showColMenu)} className="w-full justify-center px-3" title="Atur Kolom">
                                <Icon name="columns" className="w-4 h-4" /> 
                            </Button>
                            {showColMenu && (
                                <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-gray-100 p-2 z-20 flex flex-col gap-1">
                                    {Object.keys(cols).map(key => (
                                        <label key={key} className="flex items-center gap-2 p-2 hover:bg-gray-50 rounded cursor-pointer capitalize">
                                            <input type="checkbox" checked={cols[key]} onChange={() => toggleCol(key)} className="rounded text-emerald-600" />
                                            <span className="text-sm">{key}</span>
                                        </label>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                    {showColMenu && <div className="fixed inset-0 z-10" onClick={() => setShowColMenu(false)}></div>}

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden card-print">
                        <div className="hidden md:block overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50/50 text-slate-600 border-b border-slate-100">
                                    <tr>
                                        <th className="p-4 font-semibold">Nama Bahan</th>
                                        {cols.category && <th className="p-4 font-semibold">Kategori</th>}
                                        {cols.price && <th className="p-4 font-semibold no-print">Harga/Unit</th>}
                                        {cols.stock && <th className="p-4 font-semibold text-center">Stok Fisik</th>}
                                        <th className="p-4 font-semibold text-center hidden print-only">Cek Fisik</th>
                                        {cols.status && <th className="p-4 font-semibold text-center no-print">Status</th>}
                                        {cols.action && canEdit && <th className="p-4 font-semibold text-right no-print">Aksi</th>}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {filtered.length === 0 ? (
                                        <tr><td colSpan="7" className="p-12 text-center text-slate-400">Tidak ada bahan yang ditemukan.</td></tr>
                                    ) : filtered.map(item => (
                                        <tr key={item.id} className="hover:bg-slate-50/50 transition-colors group">
                                            <td className="p-4"><div className="font-medium text-slate-900 group-hover:text-emerald-700">{item.name}</div><div className="text-xs text-slate-400 font-mono mt-0.5">ID: {item.id}</div></td>
                                            {cols.category && <td className="p-4"><Badge>{item.category}</Badge></td>}
                                            {cols.price && <td className="p-4 text-slate-600 no-print">{formatRupiah(item.price)} <span className="text-slate-400">/{item.unit}</span></td>}
                                            {cols.stock && <td className="p-4 text-center"><span className={`font-bold text-lg ${item.stock <= item.minStock ? 'text-rose-600' : 'text-slate-700'}`}>{parseFloat(item.stock).toLocaleString('id-ID')}</span><span className="text-xs text-slate-400 ml-1">{item.unit}</span></td>}
                                            <td className="p-4 border-b hidden print-only border-slate-200"><div className="h-6 w-24 border-b border-slate-400 mx-auto"></div></td>
                                            {cols.status && <td className="p-4 text-center no-print">{item.stock <= item.minStock ? <Badge type="danger">Low Stock</Badge> : <Badge type="success">Tersedia</Badge>}</td>}
                                            {cols.action && canEdit && (
                                                <td className="p-4 text-right no-print">
                                                    <div className="flex justify-end gap-2">
                                                        <Button variant="secondary" className="p-2 h-8 w-8 justify-center" onClick={() => { setEditingItem(item); setShowFormModal(true); }}><Icon name="edit-2" size={14} /></Button>
                                                        <Button variant="secondary" className="p-2 h-8 w-8 justify-center text-rose-600 hover:bg-rose-50 hover:border-rose-200" onClick={() => handleDelete(item.id)}><Icon name="trash-2" size={14} /></Button>
                                                    </div>
                                                </td>
                                            )}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        <div className="md:hidden divide-y divide-slate-100">
                             {filtered.map(item => (
                                <div key={item.id} className="p-4 hover:bg-slate-50 transition-colors">
                                    <div className="flex justify-between items-start mb-2">
                                        <div>
                                            <div className="font-bold text-slate-900 text-lg">{item.name}</div>
                                            <div className="text-xs text-slate-400 flex items-center gap-2 mt-1"><Badge>{item.category}</Badge><span>ID: {item.id}</span></div>
                                        </div>
                                        <div>{item.stock <= item.minStock ? <Badge type="danger">Low</Badge> : <Badge type="success">OK</Badge>}</div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4 my-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                        <div><span className="text-xs text-slate-500 block uppercase font-semibold">Stok Fisik</span><span className={`font-bold text-lg ${item.stock <= item.minStock ? 'text-rose-600' : 'text-slate-800'}`}>{parseFloat(item.stock).toLocaleString('id-ID')} {item.unit}</span></div>
                                        <div><span className="text-xs text-slate-500 block uppercase font-semibold">Harga</span><span className="font-medium text-slate-700">{formatRupiah(item.price)}</span></div>
                                    </div>
                                    {canEdit && (
                                        <div className="flex gap-2 mt-3 pt-3 border-t border-slate-100">
                                            <Button variant="secondary" className="flex-1 justify-center text-sm h-10" onClick={() => { setEditingItem(item); setShowFormModal(true); }}><Icon name="edit-2" size={16} /> Edit</Button>
                                            <Button variant="secondary" className="flex-1 justify-center text-sm h-10 text-rose-600 border-rose-200" onClick={() => handleDelete(item.id)}><Icon name="trash-2" size={16} /> Hapus</Button>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <Modal isOpen={!!opnameItem} onClose={() => setOpnameItem(null)} title="Stok Opname">
                        {opnameItem && (
                            <form onSubmit={handleOpnameSubmit} className="space-y-4">
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-4">
                                    <div className="flex justify-between mb-1"><span className="text-sm text-blue-800">Nama Bahan:</span><span className="font-bold text-blue-900">{opnameItem.name}</span></div>
                                    <div className="flex justify-between"><span className="text-sm text-blue-800">Stok di Sistem:</span><span className="font-bold text-blue-900">{opnameItem.stock} {opnameItem.unit}</span></div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">Stok Fisik (Aktual)</label>
                                    <div className="flex gap-2">
                                        <input type="number" step="0.001" autoFocus required className="flex-1 p-3 border-2 border-emerald-500 rounded-lg text-lg font-bold text-emerald-700 outline-none" value={opnameActual} onChange={e => setOpnameActual(e.target.value)} placeholder="0"/>
                                        <div className="flex items-center px-4 bg-gray-100 rounded-lg font-medium text-gray-500">{opnameItem.unit}</div>
                                    </div>
                                </div>
                                <div className="pt-4 flex gap-2"><Button type="submit" className="flex-1 justify-center">Simpan</Button><Button variant="secondary" onClick={() => setOpnameItem(null)}>Batal</Button></div>
                            </form>
                        )}
                    </Modal>
                </div>
            );
        };

        const ItemForm = ({ editingItem, handleSaveItem, setShowFormModal }) => {
            const [form, setForm] = useState(editingItem.id ? editingItem : {
                name: '', category: 'Bahan Kering', stock: 0, unit: 'kg', price: 0, minStock: 5
            });

            const handleSubmit = (e) => {
                e.preventDefault();
                handleSaveItem({ ...form, stock: parseFloat(form.stock), price: parseFloat(form.price), minStock: parseFloat(form.minStock) });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div><label className="block text-sm font-medium mb-1">Nama Bahan</label><input type="text" required className="w-full p-2 border rounded-lg" value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium mb-1">Kategori</label><select className="w-full p-2 border rounded-lg" value={form.category} onChange={e => setForm({...form, category: e.target.value})}>{CATEGORIES.map(c => <option key={c}>{c}</option>)}</select></div>
                        <div><label className="block text-sm font-medium mb-1">Satuan</label><select className="w-full p-2 border rounded-lg" value={form.unit} onChange={e => setForm({...form, unit: e.target.value})}>{UNITS.map(u => <option key={u}>{u}</option>)}</select></div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div><label className="block text-sm font-medium mb-1">Stok Awal</label><input type="number" step="0.001" required className="w-full p-2 border rounded-lg" value={form.stock} onChange={e => setForm({...form, stock: e.target.value})} /></div>
                        <div><label className="block text-sm font-medium mb-1">Min. Stok</label><input type="number" step="0.001" required className="w-full p-2 border rounded-lg" value={form.minStock} onChange={e => setForm({...form, minStock: e.target.value})} /></div>
                    </div>
                    <div><label className="block text-sm font-medium mb-1">Harga per Unit (IDR)</label><input type="number" required className="w-full p-2 border rounded-lg" value={form.price} onChange={e => setForm({...form, price: e.target.value})} /></div>
                    <div className="pt-4 flex gap-2"><Button type="submit" className="flex-1 justify-center">Simpan</Button><Button variant="secondary" onClick={() => setShowFormModal(false)}>Batal</Button></div>
                </form>
            );
        };

        const UsageView = ({ inventory, user, handleRecordUsage, showToast, setView, usageLog }) => {
            const [selectedItemId, setSelectedItemId] = useState("");
            const [filterText, setFilterText] = useState(""); 
            const [isOpen, setIsOpen] = useState(false); 
            const [amount, setAmount] = useState("");
            const [reason, setReason] = useState("Produksi Harian");

            const selectedItem = inventory.find(i => i.id == selectedItemId);
            const filteredOptions = inventory.filter(i => i.name.toLowerCase().includes(filterText.toLowerCase())).sort((a,b) => a.name.localeCompare(b.name));

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!selectedItemId) return showToast("Pilih barang dari daftar yang tersedia", 'error');
                handleRecordUsage(selectedItemId, amount, reason);
                setAmount(""); setReason("Produksi Harian"); setFilterText(""); setSelectedItemId(""); setIsOpen(false);
            };

            return (
                <div className="max-w-4xl mx-auto space-y-8">
                    <div className="flex justify-between items-center mb-6">
                        <div><h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="clipboard-minus" className="text-emerald-600"></i> Pencatatan Pemakaian Bahan</h2><p className="text-gray-500 text-sm mt-1">Input manual untuk bahan rusak, tumpah, atau sampling</p></div>
                        <Button variant="secondary" onClick={() => setView('list')}><Icon name="arrow-left" size={16} /> Kembali ke Stok</Button>
                    </div>

                    <Card>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Pilih Bahan</label>
                                    <div className="relative">
                                        <Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-4 h-4" />
                                        <input type="text" placeholder="Cari atau pilih bahan..." className="w-full pl-9 pr-4 py-2.5 border rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none border-gray-300" value={filterText} onChange={e => { setFilterText(e.target.value); setSelectedItemId(""); setIsOpen(true); }} onFocus={() => setIsOpen(true)} onBlur={() => setTimeout(() => setIsOpen(false), 200)} />
                                        {isOpen && !selectedItemId && (
                                            <div className="absolute z-50 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-xl max-h-60 overflow-y-auto">
                                                {filteredOptions.length > 0 ? filteredOptions.map(item => (
                                                    <div key={item.id} className="px-4 py-2.5 hover:bg-emerald-50 cursor-pointer border-b border-gray-50" onClick={() => { setSelectedItemId(item.id); setFilterText(item.name); setIsOpen(false); }}>
                                                        <div className="flex justify-between items-center"><span className="font-medium text-gray-800">{item.name}</span><span className={`text-xs px-2 py-0.5 rounded-full ${item.stock <= item.minStock ? 'bg-rose-100 text-rose-600' : 'bg-gray-100 text-gray-500'}`}>Sisa: {item.stock} {item.unit}</span></div>
                                                    </div>
                                                )) : <div className="p-3 text-sm text-gray-400 text-center italic">Bahan tidak ditemukan</div>}
                                            </div>
                                        )}
                                    </div>
                                </div>
                                {selectedItem && (
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-center gap-4"><div className="bg-white p-2 rounded-full shadow-sm"><i data-lucide="package" className="text-blue-500"></i></div><div><div className="text-sm text-gray-500">Stok Tersedia</div><div className="text-lg font-bold text-gray-800">{selectedItem.stock} {selectedItem.unit}</div></div></div>
                                )}
                            </div>
                            <div className="space-y-4">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Jumlah Terpakai</label><div className="flex gap-2"><input type="number" step="0.1" min="0" placeholder="0.0" className="flex-1 p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" value={amount} onChange={e => setAmount(e.target.value)} required /><div className="bg-gray-100 px-4 py-2.5 rounded-lg text-gray-500 font-medium border border-gray-200">{selectedItem ? selectedItem.unit : '-'}</div></div></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">Keterangan / Alasan</label><select className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none" value={reason} onChange={e => setReason(e.target.value)}><option>Produksi Harian</option><option>Bahan Rusak / Basi</option><option>Spilled / Tumpah</option><option>Sampling / Tester</option><option>Lainnya</option></select></div>
                                <Button type="submit" className="w-full justify-center mt-2" disabled={!selectedItem}><i data-lucide="check-circle" className="w-4 h-4"></i> Konfirmasi Pengurangan</Button>
                            </div>
                        </form>
                    </Card>

                    <div className="space-y-4">
                        <h3 className="font-bold text-gray-700">Riwayat Penggunaan Terakhir</h3>
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-x-auto">
                            <table className="w-full text-left text-sm whitespace-nowrap">
                                <thead className="bg-gray-50 text-gray-600"><tr><th className="p-3">Waktu</th><th className="p-3">Nama Bahan</th><th className="p-3">Jumlah</th><th className="p-3">Keterangan</th><th className="p-3 text-right">Est. Biaya</th></tr></thead>
                                <tbody className="divide-y divide-gray-100">
                                    {usageLog.slice(0, 10).map(log => (
                                        <tr key={log.id} className="hover:bg-gray-50"><td className="p-3 text-gray-500">{formatDate(log.date)}</td><td className="p-3 font-medium">{log.itemName}</td><td className="p-3 font-bold text-rose-600">-{log.amount} {log.unit}</td><td className="p-3 text-gray-600"><Badge>{log.reason}</Badge></td><td className="p-3 text-right text-gray-500">{formatRupiah(log.cost)}</td></tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        const ProductView = ({ products, addProduct, updateProduct, removeProduct, inventory, showToast, canEdit, calculateHPP, handleProduce }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [tempProduct, setTempProduct] = useState(null);
            const [productionQty, setProductionQty] = useState({});
            const [expandedDetails, setExpandedDetails] = useState({});
            const [searchTerm, setSearchTerm] = useState("");

            const filteredProducts = useMemo(() => products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase())), [products, searchTerm]);
            const stockUsage = useMemo(() => {
                const usage = {};
                products.forEach(p => {
                    const qty = productionQty[p.id] || 0;
                    if (qty > 0) p.recipe.forEach(r => { if(r.itemId) usage[r.itemId] = (usage[r.itemId] || 0) + (r.qty * qty); });
                });
                return usage;
            }, [products, productionQty]);

            useEffect(() => { if (window.lucide) lucide.createIcons(); }, [isEditing, tempProduct, productionQty, filteredProducts]);

            const startEdit = (product) => {
                setTempProduct(JSON.parse(JSON.stringify(product || { name: "", overhead: 0, sellingPrice: 0, recipe: [] })));
                setIsEditing(true);
            };

            const saveProduct = () => {
                if (!tempProduct.name) return showToast("Nama produk wajib diisi", 'error');
                if (tempProduct.recipe.length === 0) return showToast("Minimal harus ada 1 bahan baku", 'error');
                if (tempProduct.id) updateProduct(tempProduct);
                else addProduct(tempProduct);
                setIsEditing(false); showToast("Resep berhasil disimpan!", 'success');
            };

            const deleteProduct = (id) => { if (confirm("Hapus produk ini?")) removeProduct(id); };

            const addIngredient = () => setTempProduct({ ...tempProduct, recipe: [{ itemId: inventory[0]?.id || "", qty: 1 }, ...tempProduct.recipe] });
            const removeIngredient = (idx) => { const newRecipe = [...tempProduct.recipe]; newRecipe.splice(idx, 1); setTempProduct({ ...tempProduct, recipe: newRecipe }); };
            const updateIngredient = (idx, field, value) => { const newRecipe = [...tempProduct.recipe]; newRecipe[idx] = { ...newRecipe[idx], [field]: value }; setTempProduct({ ...tempProduct, recipe: newRecipe }); };

            const calcTempHPP = () => {
                if (!tempProduct) return 0;
                return tempProduct.recipe.reduce((total, ing) => { const item = inventory.find(i => i.id === ing.itemId); return total + (item ? item.price * ing.qty : 0); }, 0) + (parseFloat(tempProduct.overhead) || 0);
            };

            if (isEditing) {
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm overflow-y-auto">
                        <Card className="w-full max-w-4xl mx-auto my-8 animate-in fade-in zoom-in duration-200 shadow-2xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h2 className="text-xl font-bold">{tempProduct.id ? "Edit Resep" : "Buat Resep"}</h2>
                                <button onClick={() => setIsEditing(false)}><Icon name="x" size={24} /></button>
                            </div>
                            <div className="space-y-6">
                                <div><label className="block text-sm font-medium mb-1">Nama Produk</label><input type="text" className="w-full p-2 border rounded" value={tempProduct.name} onChange={e => setTempProduct({...tempProduct, name: e.target.value})} readOnly={!canEdit} /></div>
                                <div>
                                    <div className="flex justify-between mb-2"><label className="text-sm font-medium">Komposisi</label>{canEdit && <Button size="sm" onClick={addIngredient}>+ Bahan</Button>}</div>
                                    <div className="space-y-2">
                                        {tempProduct.recipe.map((ing, idx) => {
                                            const item = inventory.find(i => i.id === ing.itemId);
                                            return (
                                                <div key={idx} className="flex gap-2 items-center">
                                                    <select className="flex-1 p-2 border rounded text-sm" value={ing.itemId} onChange={e => updateIngredient(idx, 'itemId', e.target.value)} disabled={!canEdit}>{inventory.map(i => <option key={i.id} value={i.id}>{i.name}</option>)}</select>
                                                    <input type="number" className="w-20 p-2 border rounded text-sm" value={ing.qty} onChange={e => updateIngredient(idx, 'qty', parseFloat(e.target.value))} readOnly={!canEdit} />
                                                    <span className="text-sm">{item?.unit}</span>
                                                    {canEdit && <button onClick={() => removeIngredient(idx)} className="text-red-500"><Icon name="trash-2" size={16} /></button>}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-sm font-medium">Harga Jual</label><input type="number" className="w-full p-2 border rounded" value={tempProduct.sellingPrice} onChange={e => setTempProduct({...tempProduct, sellingPrice: parseFloat(e.target.value)})} readOnly={!canEdit} /></div>
                                    <div><label className="block text-sm font-medium">Overhead</label><input type="number" className="w-full p-2 border rounded" value={tempProduct.overhead} onChange={e => setTempProduct({...tempProduct, overhead: parseFloat(e.target.value)})} readOnly={!canEdit} /></div>
                                </div>
                                <div className="p-4 bg-gray-50 rounded flex justify-between font-bold"><span>Total HPP:</span><span>{formatRupiah(calcTempHPP())}</span></div>
                                {canEdit && <div className="flex gap-2"><Button onClick={saveProduct} className="flex-1 justify-center">Simpan</Button><Button variant="secondary" onClick={() => setIsEditing(false)}>Batal</Button></div>}
                            </div>
                        </Card>
                    </div>
                );
            }

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div className="relative flex-1 md:w-64"><Icon name="search" className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5" /><input type="text" placeholder="Cari menu..." className="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-200" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                        {canEdit && <Button onClick={() => startEdit(null)}><Icon name="plus" size={20} /> Buat Menu</Button>}
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        {filteredProducts.map(product => {
                            const hpp = calculateHPP(product);
                            let limitingFactor = Infinity;
                            product.recipe.forEach(ing => {
                                const item = inventory.find(i => i.id === ing.itemId);
                                if (item) {
                                    const totalUsed = stockUsage[ing.itemId] || 0;
                                    const maxMakeable = Math.floor((item.stock - totalUsed) / ing.qty);
                                    if (maxMakeable < limitingFactor) limitingFactor = maxMakeable;
                                }
                            });
                            if (limitingFactor === Infinity) limitingFactor = 0;
                            const isDeficit = limitingFactor < 0;

                            return (
                                <Card key={product.id} className="relative flex flex-col h-full hover:shadow-lg transition-all">
                                    <div className="flex justify-between items-start mb-4">
                                        <div><h3 className="font-bold text-lg text-gray-900">{product.name}</h3><div className="text-sm text-gray-500">{product.recipe.length} Bahan Baku</div></div>
                                        <div className="flex gap-1"><button onClick={() => startEdit(product)} className="p-1.5 text-blue-600 hover:bg-blue-50 rounded"><Icon name={canEdit ? "edit-2" : "eye"} size={16} /></button>{canEdit && <button onClick={() => deleteProduct(product.id)} className="p-1.5 text-rose-600 hover:bg-rose-50 rounded"><Icon name="trash-2" size={16} /></button>}</div>
                                    </div>
                                    <div className="space-y-3 flex-1 flex flex-col">
                                        <div className="flex justify-between border-y py-2 text-center text-sm">
                                            <div className="flex-1 border-r"><div>Jual</div><div className="font-bold">{formatRupiah(product.sellingPrice)}</div></div>
                                            <div className="flex-1 border-r"><div>HPP</div><div className="font-bold">{formatRupiah(hpp)}</div></div>
                                            <div className="flex-1"><div>Margin</div><div className={(product.sellingPrice - hpp) > 0 ? "text-blue-600 font-bold" : "text-red-600 font-bold"}>{product.sellingPrice > 0 ? ((product.sellingPrice - hpp) / product.sellingPrice * 100).toFixed(0) : 0}%</div></div>
                                        </div>
                                        <div className="mt-auto">
                                            <div className="flex gap-2 items-center bg-gray-50 p-2 rounded">
                                                <input type="number" min="1" className="w-full p-1 border rounded text-center" placeholder="Qty" value={productionQty[product.id] || ''} onChange={e => setProductionQty({...productionQty, [product.id]: parseInt(e.target.value)})} />
                                                <button onClick={() => handleProduce(product, productionQty[product.id] || 0)} className="bg-emerald-500 text-white p-1 rounded"><Icon name="check" size={16} /></button>
                                                <div className="text-right flex-1"><div className="text-[10px] uppercase">Bisa Buat</div><div className={`font-bold ${isDeficit ? 'text-red-600' : 'text-emerald-600'}`}>{isDeficit ? 0 : limitingFactor}</div></div>
                                            </div>
                                            <button onClick={() => setExpandedDetails(prev => ({...prev, [product.id]: !prev[product.id]}))} className="w-full text-xs text-center mt-2 text-gray-500">Lihat Resep</button>
                                            {expandedDetails[product.id] && <ul className="text-xs bg-gray-50 p-2 rounded mt-1 list-disc pl-4">{product.recipe.map((r, i) => { const item = inventory.find(x => x.id === r.itemId); return <li key={i}>{item?.name} ({r.qty} {item?.unit})</li> })}</ul>}
                                        </div>
                                    </div>
                                </Card>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const RestockView = ({ inventory, products, user, showToast, requests, addRequest, updateRequest, removeRequest, updateInventory, restockCart, setRestockCart, formatRupiah, formatDate, handleSendRestock }) => {
            const [activeTab, setActiveTab] = useState('new'); 
            const [editingRequestId, setEditingRequestId] = useState(null);
            const [selectedRestockItems, setSelectedRestockItems] = useState(new Set()); 

            const filteredInventory = inventory.sort((a,b) => (a.stock/a.minStock) - (b.stock/b.minStock));

            const toggleItem = (itemId) => setSelectedRestockItems(prev => { const newSet = new Set(prev); if (newSet.has(itemId)) newSet.delete(itemId); else newSet.add(itemId); return newSet; });
            const updateCart = (id, value) => { const val = parseFloat(value); setRestockCart(prev => ({ ...prev, [id]: val })); if (val > 0) setSelectedRestockItems(prev => new Set(prev).add(id)); };

            const totalEstimation = inventory.reduce((acc, item) => (!selectedRestockItems.has(item.id)) ? acc : acc + ((parseFloat(restockCart[item.id]) || 0) * item.price), 0);
            const itemsInCart = inventory.filter(i => selectedRestockItems.has(i.id) && parseFloat(restockCart[i.id]) > 0).length;

            const handleSaveRequest = () => {
                const itemsToOrder = inventory.filter(i => selectedRestockItems.has(i.id) && parseFloat(restockCart[i.id]) > 0).map(item => ({
                    id: item.id, name: item.name, unit: item.unit, price: item.price, qty: parseFloat(restockCart[item.id]), isRealized: false 
                }));
                if (itemsToOrder.length === 0) return showToast("Pilih minimal 1 barang", 'error');

                const reqData = { date: new Date().toISOString(), requester: user.name, items: itemsToOrder, totalEst: totalEstimation, status: 'pending', realizedBy: null, realizedAt: null };

                if (editingRequestId) {
                    const existing = requests.find(r => r.id === editingRequestId);
                    updateRequest({ ...existing, ...reqData, requester: `${existing.requester} (Edited)` });
                    setEditingRequestId(null);
                } else {
                    addRequest(reqData);
                }
                showToast("Request berhasil disimpan!", 'success'); setRestockCart({}); setSelectedRestockItems(new Set()); setActiveTab('list');
            };

            const toggleItemRealization = (reqId, itemId) => {
                if (user.role !== 'ceo') return showToast("Hanya CEO yang bisa memvalidasi.", 'error');
                const req = requests.find(r => r.id === reqId);
                if (!req) return;

                const updatedItems = req.items.map(item => {
                    if (item.id === itemId) {
                        const isRealizing = !item.isRealized;
                        // Update stock directly in Firestore
                        const invItem = inventory.find(i => i.id === itemId);
                        if (invItem) {
                            updateInventory({ ...invItem, stock: invItem.stock + (isRealizing ? item.qty : -item.qty) });
                        }
                        return { ...item, isRealized: isRealizing };
                    }
                    return item;
                });

                const allRealized = updatedItems.every(item => item.isRealized);
                updateRequest({ ...req, items: updatedItems, status: allRealized ? 'done' : 'pending', realizedBy: allRealized ? user.name : req.realizedBy, realizedAt: allRealized ? new Date().toISOString() : null });
            };

            return (
                <div className="h-[calc(100vh-100px)] flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <div className="flex bg-gray-100 p-1 rounded-lg">
                            <button onClick={() => { setActiveTab('new'); setEditingRequestId(null); setRestockCart({}); }} className={`px-4 py-2 rounded-md text-sm font-medium ${activeTab === 'new' ? 'bg-white shadow' : 'text-gray-500'}`}>Buat Baru</button>
                            <button onClick={() => setActiveTab('list')} className={`px-4 py-2 rounded-md text-sm font-medium ${activeTab === 'list' ? 'bg-white shadow' : 'text-gray-500'}`}>Daftar Request</button>
                        </div>
                    </div>
                    {activeTab === 'new' ? (
                        <>
                           <div className="flex justify-between bg-white p-3 rounded-xl border mb-4 sticky top-0 z-20">
                                <div className="font-bold text-emerald-700">Total: {formatRupiah(totalEstimation)}</div>
                                <div className="flex gap-2"><Button variant="outline" onClick={handleSendRestock} disabled={itemsInCart === 0}><Icon name="share-2" size={18} /></Button><Button onClick={handleSaveRequest} disabled={itemsInCart === 0}><Icon name="save" size={18} /> Simpan</Button></div>
                           </div>
                           <div className="flex-1 overflow-auto">
                                <table className="w-full text-left text-sm bg-white">
                                    <thead className="bg-gray-100 sticky top-0"><tr><th className="p-3 w-10"></th><th className="p-3">Bahan</th><th className="p-3">Stok</th><th className="p-3">Qty Order</th><th className="p-3 text-right">Subtotal</th></tr></thead>
                                    <tbody>
                                        {filteredInventory.map(item => (
                                            <tr key={item.id} className="border-b">
                                                <td className="p-3 text-center"><input type="checkbox" checked={selectedRestockItems.has(item.id)} onChange={() => toggleItem(item.id)} /></td>
                                                <td className="p-3"><div>{item.name}</div><div className="text-xs text-gray-500">{formatRupiah(item.price)}</div></td>
                                                <td className="p-3">{item.stock} {item.unit} {item.stock <= item.minStock && <Badge type="danger">Low</Badge>}</td>
                                                <td className="p-3"><input type="number" className="w-20 p-1 border rounded" value={restockCart[item.id]||''} onChange={e=>updateCart(item.id, e.target.value)} /></td>
                                                <td className="p-3 text-right">{formatRupiah((parseFloat(restockCart[item.id])||0)*item.price)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                           </div>
                        </>
                    ) : (
                        <div className="flex-1 overflow-auto space-y-4">
                            {requests.map(req => (
                                <Card key={req.id} className={req.status === 'done' ? 'opacity-60' : 'border-l-4 border-l-emerald-500'}>
                                    <div className="flex justify-between mb-2"><div><span className="font-bold">REQ-{req.id.slice(0,6)}</span> <span className="text-xs text-gray-500">{formatDate(req.date)}</span></div><Badge type={req.status==='done'?'success':'warning'}>{req.status}</Badge></div>
                                    <div className="bg-gray-50 p-2 rounded text-sm space-y-1">
                                        {req.items.map((item, idx) => (
                                            <div key={idx} className="flex justify-between items-center">
                                                <div className="flex gap-2 items-center">
                                                    {user.role === 'ceo' ? <input type="checkbox" checked={item.isRealized} onChange={() => toggleItemRealization(req.id, item.id)} /> : (item.isRealized && <Icon name="check" size={12} />)}
                                                    <span className={item.isRealized ? 'line-through text-gray-400' : ''}>{item.name}</span>
                                                </div>
                                                <div>{item.qty} {item.unit}</div>
                                            </div>
                                        ))}
                                    </div>
                                    {user.role !== 'ceo' && req.status !== 'done' && <div className="text-xs text-right mt-2 text-gray-400">Menunggu CEO</div>}
                                    <div className="flex justify-end mt-2"><button onClick={() => removeRequest(req.id)} className="text-red-500 text-xs"><Icon name="trash-2" size={14}/></button></div>
                                </Card>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const HPPCalculator = ({ inventory, formatRupiah }) => {
            const [targetQty, setTargetQty] = useState(1);
            const [components, setComponents] = useState([]);
            const [extras, setExtras] = useState([]);
            const [desiredMargin, setDesiredMargin] = useState(30);
            const [sellingPrice, setSellingPrice] = useState(0);

            const addComponent = () => setComponents([...components, { id: Date.now(), itemId: inventory[0]?.id || "", qty: 1, unit: 'pcs', price: 0 }]);
            const updateComponent = (idx, field, value) => {
                const newComps = [...components];
                if (field === 'itemId') {
                    const item = inventory.find(i => i.id === value);
                    newComps[idx] = { ...newComps[idx], itemId: value, name: item?.name, price: item?.price || 0, unit: item?.unit };
                } else newComps[idx][field] = value;
                setComponents(newComps);
            };
            const removeComponent = (idx) => setComponents(components.filter((_, i) => i !== idx));

            const totalMaterial = components.reduce((sum, c) => sum + (c.price * c.qty), 0);
            const totalExtra = extras.reduce((sum, e) => sum + e.cost, 0);
            const hppPerUnit = (totalMaterial + totalExtra) / (targetQty || 1);
            const suggestedPrice = hppPerUnit / (1 - (desiredMargin / 100));

            return (
                <div className="space-y-6 max-w-5xl mx-auto pb-20">
                    <div className="flex justify-between"><h2 className="text-xl font-bold">Kalkulator HPP</h2><div className="flex items-center gap-2"><span className="text-sm">Target Qty:</span><input type="number" className="w-16 p-1 border rounded text-center" value={targetQty} onChange={e => setTargetQty(parseFloat(e.target.value)||1)} /></div></div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <Card>
                            <div className="flex justify-between mb-4 font-bold text-emerald-700"><span>Bahan Baku</span><button onClick={addComponent}><Icon name="plus" size={16}/></button></div>
                            <div className="space-y-2">
                                {components.map((c, i) => (
                                    <div key={c.id} className="flex gap-2 items-center text-sm">
                                        <select className="flex-1 border p-1 rounded" value={c.itemId} onChange={e=>updateComponent(i,'itemId',e.target.value)}>{inventory.map(inv=><option key={inv.id} value={inv.id}>{inv.name}</option>)}</select>
                                        <input type="number" className="w-16 p-1 border rounded" value={c.qty} onChange={e=>updateComponent(i,'qty',e.target.value)} />
                                        <span className="w-20 text-right">{formatRupiah(c.price*c.qty)}</span>
                                        <button onClick={()=>removeComponent(i)} className="text-red-500"><Icon name="trash-2" size={14}/></button>
                                    </div>
                                ))}
                            </div>
                        </Card>
                        <Card className="bg-slate-800 text-white">
                            <div className="text-center py-6">
                                <div className="text-sm text-slate-400">HPP Per Unit</div>
                                <div className="text-3xl font-bold text-emerald-400">{formatRupiah(hppPerUnit)}</div>
                            </div>
                            <div className="p-4 border-t border-slate-700 space-y-4">
                                <div>
                                    <div className="flex justify-between text-xs text-slate-400 mb-1"><span>Target Margin {desiredMargin}%</span><span>Jual: {formatRupiah(suggestedPrice)}</span></div>
                                    <input type="range" className="w-full" value={desiredMargin} onChange={e=>setDesiredMargin(parseInt(e.target.value))} />
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        const FinanceView = ({ usageLog, requests, inventory, products, user, formatRupiah, formatDate }) => {
            const [startDate, setStartDate] = useState(new Date().toISOString().slice(0, 10).substring(0,8)+"01");
            const [endDate, setEndDate] = useState(new Date().toISOString().slice(0, 10));
            const [operationalCost, setOperationalCost] = useState(0); 

            const filteredLogs = useMemo(() => usageLog.filter(log => log.date.slice(0, 10) >= startDate && log.date.slice(0, 10) <= endDate), [usageLog, startDate, endDate]);
            const financeStats = useMemo(() => {
                let revenue = 0, cogs = 0, waste = 0;
                filteredLogs.forEach(log => {
                    if (log.reason && log.reason.toLowerCase().includes("produksi")) {
                        let itemRev = log.revenue || 0;
                        if (!itemRev) { const p = products.find(prod => prod.id === log.itemId); itemRev = p ? p.sellingPrice * log.amount : 0; }
                        revenue += itemRev; cogs += log.cost;
                    } else waste += log.cost;
                });
                return { revenue, cogs, waste, grossProfit: revenue - cogs, netProfit: (revenue - cogs) - waste - operationalCost };
            }, [filteredLogs, operationalCost, products]);

            return (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="bg-white p-6 rounded-2xl shadow-sm border flex flex-col md:flex-row justify-between gap-4">
                        <div><h2 className="text-xl font-bold">Laporan Keuangan</h2><p className="text-gray-500 text-sm">Periode {formatDate(startDate)} - {formatDate(endDate)}</p></div>
                        <div className="flex gap-2 items-end">
                            <div><label className="text-xs">Mulai</label><input type="date" className="border p-2 rounded" value={startDate} onChange={e=>setStartDate(e.target.value)} /></div>
                            <div><label className="text-xs">Sampai</label><input type="date" className="border p-2 rounded" value={endDate} onChange={e=>setEndDate(e.target.value)} /></div>
                            <div><label className="text-xs">Ops Cost</label><input type="number" className="border p-2 rounded w-24" value={operationalCost} onChange={e=>setOperationalCost(parseFloat(e.target.value)||0)} /></div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-xl border shadow-sm">
                            <div className="text-sm text-gray-500">Pendapatan</div>
                            <div className="text-2xl font-bold text-emerald-600">{formatRupiah(financeStats.revenue)}</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border shadow-sm">
                            <div className="text-sm text-gray-500">HPP & Modal</div>
                            <div className="text-2xl font-bold text-blue-600">{formatRupiah(financeStats.cogs)}</div>
                        </div>
                         <div className="bg-white p-4 rounded-xl border shadow-sm">
                            <div className="text-sm text-gray-500">Beban & Waste</div>
                            <div className="text-2xl font-bold text-rose-600">{formatRupiah(financeStats.waste + operationalCost)}</div>
                        </div>
                         <div className="bg-slate-800 p-4 rounded-xl border shadow-sm text-white">
                            <div className="text-sm text-slate-400">Net Profit</div>
                            <div className={`text-2xl font-bold ${financeStats.netProfit>=0?'text-emerald-400':'text-rose-400'}`}>{formatRupiah(financeStats.netProfit)}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ inventory, products, addInventory, addProduct }) => {
            const seedData = async () => {
                if (confirm("Upload data awal? Lakukan ini HANYA JIKA database masih kosong.")) {
                   // Seed Inventory
                   for (const item of initialData) await addInventory(item);
                   // Seed Products (Dummy for example)
                   // for (const prod of initialProducts) await addProduct(prod); 
                   alert("Data awal berhasil diupload!");
                }
            };
            return (
                <div className="max-w-4xl mx-auto space-y-8">
                     <Card>
                        <h2 className="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2"><Icon name="database" className="text-blue-600" /> Manajemen Data</h2>
                        <div className="p-4 bg-blue-50 rounded-xl border border-blue-200">
                            <h3 className="font-bold text-blue-900">Upload Data Awal (Seeding)</h3>
                            <p className="text-sm text-blue-700 mb-4">Gunakan tombol ini jika aplikasi masih kosong (pertama kali pakai).</p>
                            <Button onClick={seedData}>Upload Data Demo</Button>
                        </div>
                    </Card>
                </div>
            );
        };

        function KitchenPro() {
            const { showToast } = useToast();
            const [user, setUser] = useState(() => JSON.parse(localStorage.getItem('fnb_user_role')) || null);
            const [view, setView] = useState('dashboard');
            
            // --- FIRESTORE HOOKS REPLACING LOCAL STORAGE ---
            const { data: inventory, add: addInventory, update: updateInventory, remove: removeInventory } = useFirestore("inventory");
            const { data: products, add: addProduct, update: updateProduct, remove: removeProduct } = useFirestore("products");
            const { data: usageLog, add: addLog } = useFirestore("usage_log");
            const { data: requests, add: addRequest, update: updateRequest, remove: removeRequest } = useFirestore("requests");
            const [restockCart, setRestockCart] = useState({});

            const [editingItem, setEditingItem] = useState(null);
            const [searchTerm, setSearchTerm] = useState("");
            const [showFormModal, setShowFormModal] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(window.innerWidth >= 768);

            useEffect(() => {
                if (user) localStorage.setItem('fnb_user_role', JSON.stringify(user));
                else localStorage.removeItem('fnb_user_role');
            }, [user]);

            useEffect(() => { if (user) lucide.createIcons(); });

            const handleLogin = (role, features) => { setUser({ role, name: role === 'owner' ? 'Owner' : 'CEO', features: ['dashboard', 'settings', ...features] }); setView('dashboard'); };
            const handleLogout = () => { setUser(null); setRestockCart({}); };
            const canEdit = user?.role === 'owner';

            const stats = useMemo(() => {
                const totalItems = inventory.length;
                const lowStockItems = inventory.filter(item => item.stock <= item.minStock).length;
                const totalValue = inventory.reduce((acc, item) => acc + (item.stock * item.price), 0);
                const usageThisMonth = usageLog.length;
                return { totalItems, lowStockItems, totalValue, usageThisMonth };
            }, [inventory, usageLog]);

            const handleSaveItem = (item) => {
                if (item.id) updateInventory(item);
                else addInventory(item);
                setShowFormModal(false); setEditingItem(null);
            };

            const handleDelete = (id) => { if (confirm('Hapus item ini?')) removeInventory(id); };

            const handleRecordUsage = (itemId, amount, reason) => {
                const item = inventory.find(i => i.id == itemId);
                if (!item) return;
                const qty = parseFloat(amount);
                if (item.stock < qty) return showToast(`Stok tidak cukup!`, 'error');
                
                updateInventory({ ...item, stock: item.stock - qty });
                addLog({ date: new Date().toISOString(), itemId: item.id, itemName: item.name, amount: qty, unit: item.unit, reason: reason, cost: qty * item.price });
                showToast("Pemakaian dicatat!", 'success');
            };

            const calculateHPP = (product) => {
                return product.recipe.reduce((total, ing) => {
                    const item = inventory.find(i => i.id === ing.itemId);
                    return total + (item ? item.price * ing.qty : 0);
                }, 0) + (parseFloat(product.overhead) || 0);
            };

            const handleProduce = async (product, qty) => {
                if (qty <= 0) return;
                const missing = [];
                product.recipe.forEach(ing => {
                     const item = inventory.find(i => i.id === ing.itemId);
                     if (!item || item.stock < (ing.qty * qty)) missing.push(item?.name);
                });
                if (missing.length) return showToast(`Stok kurang: ${missing.join(', ')}`, 'error');
                if (!confirm(`Produksi ${qty} ${product.name}?`)) return;

                // Update Stocks
                for (const ing of product.recipe) {
                    const item = inventory.find(i => i.id === ing.itemId);
                    await updateInventory({ ...item, stock: item.stock - (ing.qty * qty) });
                }

                // Log Production
                const hpp = calculateHPP(product);
                addLog({ date: new Date().toISOString(), itemId: product.id, itemName: `[Produksi] ${product.name}`, amount: qty, unit: "porsi", reason: "Produksi", cost: hpp * qty, revenue: (product.sellingPrice || 0) * qty });
                showToast("Produksi berhasil!", 'success');
            };

            const handleSendRestock = () => {
                const itemsToOrder = inventory.filter(i => restockCart[i.id] && parseFloat(restockCart[i.id]) > 0);
                let message = `*REQUEST RESTOCK*\n----------------\n`;
                let total = 0;
                itemsToOrder.forEach(item => {
                     const sub = parseFloat(restockCart[item.id]) * item.price;
                     total += sub;
                     message += `- ${item.name}: ${restockCart[item.id]} ${item.unit}\n`;
                });
                message += `----------------\nTotal: ${formatRupiah(total)}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
            };

            const Dashboard = () => (
                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    {[
                        { title: "Total Aset", value: formatRupiah(stats.totalValue), icon: "wallet", color: "emerald" },
                        { title: "Item Stok", value: stats.totalItems, icon: "package", color: "blue" },
                        { title: "Perlu Restock", value: stats.lowStockItems, icon: "alert-octagon", color: "rose" },
                        { title: "Aktivitas", value: stats.usageThisMonth, icon: "activity", color: "violet" }
                    ].map((w,i)=>(<div key={i} className="bg-white p-6 rounded-2xl border shadow-sm"><div className="text-gray-500 text-sm">{w.title}</div><div className={`text-2xl font-bold text-${w.color}-600`}>{w.value}</div></div>))}
                 </div>
            );

            // --- MAIN RENDER ---
            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden font-sans">
                    {!user && <LoginScreen onLogin={handleLogin} />}
                    {user && (
                        <>
                            {/* Sidebar */}
                            <div className={`fixed inset-y-0 left-0 text-white transition-all z-50 flex flex-col no-print ${user.role === 'owner' ? 'bg-slate-900' : 'bg-indigo-900'} ${isSidebarOpen ? 'w-64' : 'w-0 md:w-20'} overflow-hidden`}>
                                <div className="h-16 flex items-center px-6 border-b border-white/10 gap-3"><Icon name="chef-hat" size={24} /><span className={!isSidebarOpen && 'hidden'}>KitchenPro</span></div>
                                <nav className="p-4 space-y-2 flex-1">
                                    {[
                                        { id: 'dashboard', icon: 'layout-grid', label: 'Dashboard' },
                                        { id: 'list', icon: 'package', label: 'Stok Bahan' },
                                        { id: 'products', icon: 'coffee', label: 'Menu Resep' },
                                        { id: 'hpp', icon: 'calculator', label: 'Kalkulator HPP' },
                                        { id: 'usage', icon: 'clipboard-minus', label: 'Pemakaian' },
                                        { id: 'restock', icon: 'shopping-cart', label: 'Restock' },
                                        { id: 'finance', icon: 'banknote', label: 'Keuangan', role: 'owner' },
                                        { id: 'settings', icon: 'settings', label: 'Pengaturan' },
                                    ].filter(m => !m.role || m.role === user.role).map(m => (
                                        <button key={m.id} onClick={() => setView(m.id)} className={`w-full flex items-center gap-3 px-3 py-3 rounded-xl ${view === m.id ? 'bg-white/10' : 'hover:bg-white/5'}`}><Icon name={m.icon} size={20}/><span className={!isSidebarOpen && 'hidden'}>{m.label}</span></button>
                                    ))}
                                </nav>
                                <div className="p-4 border-t border-white/10"><button onClick={handleLogout} className="flex gap-2 text-red-300"><Icon name="log-out"/> <span className={!isSidebarOpen && 'hidden'}>Logout</span></button></div>
                            </div>

                            <main className={`flex-1 flex flex-col transition-all ml-0 ${isSidebarOpen ? 'md:ml-64' : 'md:ml-20'}`}>
                                <div className="md:hidden bg-white p-4 border-b flex justify-between"><span className="font-bold">KitchenPro</span><button onClick={()=>setIsSidebarOpen(!isSidebarOpen)}><Icon name="menu"/></button></div>
                                <div className="flex-1 overflow-auto p-4 md:p-8">
                                    <h2 className="text-2xl font-bold mb-6 capitalize">{view.replace('_',' ')}</h2>
                                    {view === 'dashboard' && <Dashboard />}
                                    {view === 'list' && <InventoryList inventory={inventory} products={products} searchTerm={searchTerm} setSearchTerm={setSearchTerm} user={user} canEdit={canEdit} setEditingItem={setEditingItem} setShowFormModal={setShowFormModal} handleDelete={handleDelete} updateInventory={updateInventory} addLog={addLog} showToast={showToast} formatRupiah={formatRupiah} setView={setView} />}
                                    {view === 'products' && <ProductView products={products} addProduct={addProduct} updateProduct={updateProduct} removeProduct={removeProduct} inventory={inventory} showToast={showToast} canEdit={canEdit} calculateHPP={calculateHPP} handleProduce={handleProduce} />}
                                    {view === 'hpp' && <HPPCalculator inventory={inventory} formatRupiah={formatRupiah} />}
                                    {view === 'usage' && <UsageView inventory={inventory} user={user} handleRecordUsage={handleRecordUsage} showToast={showToast} setView={setView} usageLog={usageLog} />}
                                    {view === 'restock' && <RestockView inventory={inventory} products={products} user={user} showToast={showToast} requests={requests} addRequest={addRequest} updateRequest={updateRequest} removeRequest={removeRequest} updateInventory={updateInventory} restockCart={restockCart} setRestockCart={setRestockCart} formatRupiah={formatRupiah} formatDate={formatDate} handleSendRestock={handleSendRestock} />}
                                    {view === 'finance' && <FinanceView usageLog={usageLog} requests={requests} inventory={inventory} products={products} user={user} formatRupiah={formatRupiah} formatDate={formatDate} />}
                                    {view === 'settings' && <SettingsView inventory={inventory} products={products} addInventory={addInventory} addProduct={addProduct} />}
                                </div>
                            </main>
                        </>
                    )}
                    <Modal isOpen={showFormModal} onClose={() => setShowFormModal(false)} title={editingItem?.id ? "Edit Bahan" : "Tambah Bahan"}>
                        <ItemForm editingItem={editingItem} handleSaveItem={handleSaveItem} setShowFormModal={setShowFormModal} />
                    </Modal>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        function App() { return (<ToastProvider><KitchenPro /></ToastProvider>); }
        root.render(<App />);
    </script>
</body>
</html>
